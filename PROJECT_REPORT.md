# プロジェクト監査・改修レポート

**バージョン**: 3.0.0  
**最終更新日**: 2025-10-12

## 概要

このドキュメントは、`recipe-management` プロジェクトに対して実施された、全体的なコード監査と、それに伴う大規模な修正・機能改善についてまとめたものです。

当初の目的であった「CSVアップロード機能の不具合修正」から始まり、セキュリティ、パフォーマンス、信頼性、機能性の各側面にわたる包括的な改修を行いました。

---

## 1. 現在のプロジェクト構成

```
recipe-management/
├── app.py                    # Flaskメインアプリケーション、APIエンドポイント
├── cost_master_manager.py    # 原価マスター管理（LINEからのCRUD操作）
├── cost_calculator.py        # レシピ原価計算ロジック
├── azure_vision.py           # Azure Vision APIによる画像OCR処理
├── groq_parser.py            # Groq LLMによるテキスト構造化
├── requirements.txt          # Python依存パッケージ
├── Procfile                  # Render用設定ファイル
├── runtime.txt               # Python実行バージョン
├── .env                      # 環境変数（秘密キーなどを格納）
├── env.template              # .envファイルのテンプレート
├── templates/
│   └── index.html            # Web管理画面のHTML
├── static/
│   └── js/
│       └── admin.js          # Web管理画面のJavaScript
├── supabase/
│   └── migrations/           # データベースのスキーマ定義
├── PROJECT_REPORT.md         # このレポート
└── README.md                 # プロジェクトの基本情報
```

### 各ファイルの役割

-   **`app.py`**: Webサーバーの起動、LINE Webhookの受信、Web管理画面の表示、各種APIエンドポイントの提供など、アプリケーション全体の司令塔です。
-   **`cost_master_manager.py`**: LINEからの「追加」「確認」「削除」といったコマンドを受け、原価マスターデータベースを操作します。
-   **`cost_calculator.py`**: レシピの材料リストと原価マスターを照合し、全体の原価を計算するコアロジックです。
-   **`azure_vision.py`**: LINEで受信した画像をAzure Vision APIに送信し、画像内の文字（レシピ）をテキストとして抽出します。
-   **`groq_parser.py`**: 抽出されたテキストをGroqのLLM（大規模言語モデル）に渡し、料理名、材料、分量などを構造化されたデータ（JSON）に変換します。

---

## 2. 修正・改善点の総括

今回の監査と改修によって、以下の多岐にわたる改善が実施されました。

### カテゴリ別改善点

| カテゴリ | 改善内容 |
| :--- | :--- |
| 🐛 **バグ修正** | ・**CSVアップロード**: 文字コード（BOM, Shift-JIS）の問題、ファイル内の重複、空データなどを処理できるように修正し、あらゆる形式のCSVを安定して登録可能に。<br>・**データクリア**: データベースの親子関係を考慮した正しい順序で削除するように修正し、エラーを解消。 |
| 🛡️ **セキュリティ** | ・**DBアクセスキーの統一**: アプリケーション全体で、安全な**サービスロールキー**を使用するように統一。これにより、意図しないデータベース操作を防ぎ、RLS（行単位セキュリティ）を正しくバイパス可能に。 |
| 🚀 **パフォーマンス** | ・**バッチ処理**: CSVアップロードやデータ登録時、1件ずつではなく、まとめてデータベースに送信するバッチ処理に統一。これにより、サーバーへの負荷と処理時間が大幅に削減され、接続エラーが解消。 |
| ✨ **新機能** | ・**会話記憶機能**: ユーザーごとの会話の文脈（直前に解析したレシピなど）を記憶する機能を実装。これにより、「これの材料は？」といった自然な後続質問への応答が可能に。<br>・**クリア操作の安全性向上**: Web管理画面でのデータクリア時、確認のために「クリア」と入力させるポップアップを導入し、誤操作を防止。 |
| 🔧 **信頼性・品質** | ・**Azure画像解析の安定化**: 固定時間待機する不安定な方式から、解析完了までステータスを確認し続けるポーリング方式に改善。<br>・**LINE SDKの近代化**: 旧式のLINE Botライブラリ（SDK）を最新のv3に更新。これにより、将来的な互換性の問題が解消され、コードの品質が向上。 |

---

## 3. 最終的な運用方法

### ローカル環境での実行

1.  `.env` ファイルに、LINE、Supabase、Azure、Groqの全てのキー（`SUPABASE_SERVICE_KEY` を含む）が正しく設定されていることを確認します。
2.  ターミナルで以下のコマンドを実行し、必要なライブラリをインストールします。
    ```bash
    pip install -r requirements.txt
    ```
3.  以下のコマンドでWebサーバーを起動します。（ポート5000が使用中の場合は、`PORT=5001` のように変更してください）
    ```bash
    python3 app.py
    ```
4.  Web管理画面には `http://localhost:5000/` でアクセスできます。

### LINE Botの動作確認

1.  LINEアプリからボットにレシピ画像を送信し、原価計算が返ってくることを確認します。
2.  その直後、「合計金額は？」「材料を教えて」などの後続質問を送信し、ボットが文脈を理解した応答を返すことを確認します。
3.  `追加 トマト 1個 100円` のようなコマンドを送信し、原価が登録されることを確認します。

### Web管理画面の動作確認

1.  `http://localhost:5000/` にアクセスします。
2.  「原価表CSV」または「取引データCSV」を選択し、それぞれの形式のCSVファイルをアップロードして、データが登録されることを確認します。
3.  「データベースをクリア」ボタンを押し、「クリア」と入力することでデータが全件削除されることを確認します。

---

## 4. 今後の推奨事項

-   **テストコードの拡充**: 今回の修正と新機能に対するテストコードを追加することで、将来の変更時に意図しない不具合（リグレッション）が発生するのを防ぐことができます。
-   **さらなるLLMの活用**: 材料名の表記ゆれ（例: 「豚肉」と「豚バラ肉」）を吸収する類義語辞書をLLMに生成させるなど、さらなる精度向上が見込めます。


以上
