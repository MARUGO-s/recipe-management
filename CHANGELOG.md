# 変更履歴

## [3.0.0] - 2025-10-12

### 🎉 新機能

- **会話記憶機能**: LINE Botが直前の会話（レシピ解析結果）を記憶し、「これの材料は？」といった文脈に沿った質問に答えられるようになりました。
- **多言語翻訳機能**: 画像内のテキストが日本語でない場合、自動で日本語に翻訳してからレシピを解析する機能を追加しました。
- **データクリア時の安全確認**: Web管理画面でのデータクリア時に、「クリア」と入力しないと実行されない確認ポップアップを導入しました。

### ✨ 改善・修正

- **セキュリティ向上**: アプリケーション全体で、Supabaseへの接続に安全なサービスロールキーを使用するように統一しました。
- **CSVアップロード機能の完全改修**:
  - **パフォーマンス改善**: データベースへの書き込みを1件ずつからバッチ処理に切り替え、サーバー負荷を軽減し接続エラーを解消しました。
  - **文字コード対応**: BOM付きファイル(`utf-8-sig`)やShift-JIS(`cp932`)など、様々な形式のCSVを正しく読み込めるようにしました。
  - **重複データ対応**: CSVファイル内に同じ材料名が複数あっても、エラーを起こさず正しく処理できるように修正しました。
  - **空データ耐性**: CSVの行に空のデータがあっても、エラーにならず安全にスキップするように修正しました。
- **単位変換ロジックの改善**: 原価計算時、`g`と`個`のような異なるカテゴリの単位を無理に変換せず、計算できない場合はスキップするようにロジックを厳密化しました。
- **信頼性向上**: Azure画像解析の非同期処理を、固定時間待機から、完了までステータスを確認するポーリング方式に改善しました。
- **ライブラリの近代化**: `line-bot-sdk` をv3に更新し、非推奨となっていた古いコードを全て新しい書き方に修正しました。
- **バグ修正**: 
  - データクリア機能が外部キー制約違反で失敗する問題を修正しました。
  - Web管理画面でCSVテンプレートのダウンロードが失敗する問題を修正しました。

---

## [2.0.0] - 2025-10-12

### 🎉 新機能

#### LINEから原価表管理が可能に

- **原価追加**: 自然言語で原価を追加できるようになりました
- **原価確認**: 登録済み材料の価格を確認できます
- **原価削除**: 不要な材料を削除できます
- **原価一覧**: 登録されている全材料を表示

### 🔧 技術詳細

**追加されたエンドポイント/ハンドラー:**
- `handle_add_cost_command()`: 原価追加処理
- `handle_check_cost_command()`: 原価確認処理
- `handle_delete_cost_command()`: 原価削除処理
- `handle_list_cost_command()`: 原価一覧処理

---

## [1.0.0] - 2025-10-12

### 初回リリース

- LINE Bot統合
- Azure Vision APIによる画像解析（OCR）
- Groq LLMによるレシピテキスト構造化
- Supabaseへのレシピ保存
- 原価計算機能